(()=>{var e={};e.id=619,e.ids=[619],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},66541:e=>{"use strict";e.exports=require("@prisma/client/runtime/library")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},43722:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>w,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{GET:()=>u});var o=t(42706),i=t(28203),n=t(45994),d=t(39187),a=t(45369),c=t(11587);async function u(){let e=await (0,a.j)();if(!e?.user)return d.NextResponse.json({error:"Unauthorized"},{status:401});try{let r="string"==typeof e.user.id?parseInt(e.user.id,10):e.user.id,t=await c.z.user.findUnique({where:{id:r},select:{id:!0,name:!0,email:!0,image:!0,bio:!0,rank:!0,department:!0,discordId:!0,role:!0,createdAt:!0}});if(!t)return d.NextResponse.json({error:"User not found"},{status:404});return d.NextResponse.json({user:t})}catch(e){return console.error("Error fetching user:",e),d.NextResponse.json({error:"Failed to fetch user"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/users/me/route",pathname:"/api/users/me",filename:"route",bundlePath:"app/api/users/me/route"},resolvedPagePath:"C:\\xampp\\nodejs-apps\\community-forum\\app\\api\\users\\me\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:p,workUnitAsyncStorage:f,serverHooks:m}=l;function w(){return(0,n.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:f})}},96487:()=>{},78335:()=>{},45369:(e,r,t)=>{"use strict";t.d(r,{N:()=>c,j:()=>u});var s=t(46814),o=t(34926),i=t(51825),n=t(91642),d=t(64912),a=t(11587);let c={adapter:(0,s.y)(a.z),pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error"},session:{strategy:"jwt"},providers:[(0,d.A)({clientId:process.env.DISCORD_CLIENT_ID||"",clientSecret:process.env.DISCORD_CLIENT_SECRET||"",authorization:{params:{scope:"identify email"}},callbackUrl:"http://198.154.99.127:3000/auth/discord/callback",profile:e=>(console.log("Discord profile received:",e),{id:e.id,name:e.username,email:e.email,image:e.avatar?`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.png`:null})}),(0,n.A)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=await a.z.user.findUnique({where:{email:e.email}});return r&&r.password&&await (0,o.UD)(e.password,r.password)?{id:r.id,email:r.email,name:r.name,image:r.image,role:r.role}:null}})],callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="discord"&&t)try{console.log("Discord sign-in for user ID:",e.id),await a.z.user.update({where:{id:Number.parseInt(e.id,10)},data:{discordId:t.id,department:"N_A"}}),console.log("Updated user with Discord ID from profile:",t.id),setTimeout(async()=>{try{let r=await a.z.account.findFirst({where:{provider:"discord",userId:Number.parseInt(e.id,10)}});r&&(console.log("Found Discord account in accounts table:",r.providerAccountId),await a.z.user.update({where:{id:Number.parseInt(e.id,10)},data:{discordId:r.providerAccountId}}),console.log("Updated user with Discord ID from accounts table"))}catch(e){console.error("Error in delayed Discord ID update:",e)}},2e3)}catch(e){console.error("Error updating Discord ID during sign-in:",e)}return!0},async session({session:e,token:r}){if(e.user&&r.sub){e.user.id=r.sub,e.user.role=r.role,r.discordId&&(e.user.discordId=r.discordId);try{let t=Number.parseInt(r.sub,10),s=await a.z.user.findUnique({where:{id:t},select:{discordId:!0,department:!0,role:!0}});if(s&&(s.discordId&&(e.user.discordId=s.discordId),e.user.department=s.department,e.user.role=s.role,console.log("Session updated with user data:",{discordId:s.discordId,department:s.department,role:s.role}),!s.discordId)){let r=await a.z.account.findFirst({where:{provider:"discord",userId:t}});r&&(console.log("Found Discord account but user doesn't have Discord ID. Updating..."),await a.z.user.update({where:{id:t},data:{discordId:r.providerAccountId}}),e.user.discordId=r.providerAccountId,console.log("Updated user and session with Discord ID from accounts table"))}}catch(e){console.error("Error fetching user data for session:",e)}}return e},jwt:async({token:e,user:r,account:t,profile:s})=>(t&&r&&("discord"===t.provider&&s&&(e.discordId=s.id,console.log("Added Discord ID to JWT token:",s.id)),e.role=r.role),e)},events:{async createUser(e){let{user:r}=e;if(console.log("New user created:",r.id,r.email),r.email)try{setTimeout(async()=>{try{let e=await a.z.account.findFirst({where:{userId:r.id,provider:"discord"}});e&&(console.log("Found Discord account for new user:",e.providerAccountId),await a.z.user.update({where:{id:r.id},data:{discordId:e.providerAccountId,department:"N_A",role:"APPLICANT"}}),console.log("Updated new user with Discord ID and set as APPLICANT"))}catch(e){console.error("Error in delayed createUser processing:",e)}},2e3)}catch(e){console.error("Error in createUser event:",e)}},async linkAccount({user:e,account:r,profile:t}){if("discord"===r.provider&&t){console.log("Account linked:",e.id,r.provider,r.providerAccountId);try{await a.z.user.update({where:{id:e.id},data:{discordId:r.providerAccountId}}),console.log("Updated user with Discord ID from linkAccount event")}catch(e){console.error("Error updating Discord ID in linkAccount event:",e)}}}}};async function u(){return await (0,i.getServerSession)(c)}},11587:(e,r,t)=>{"use strict";t.d(r,{z:()=>o});var s=t(96330);let o=globalThis.prisma??new s.PrismaClient},37301:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"createDedupedByCallsiteServerErrorLoggerDev",{enumerable:!0,get:function(){return a}});let s=function(e,r){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=o(void 0);if(t&&t.has(e))return t.get(e);var s={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var d=i?Object.getOwnPropertyDescriptor(e,n):null;d&&(d.get||d.set)?Object.defineProperty(s,n,d):s[n]=e[n]}return s.default=e,t&&t.set(e,s),s}(t(76301));function o(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(o=function(e){return e?t:r})(e)}let i={current:null},n="function"==typeof s.cache?s.cache:e=>e,d=console.warn;function a(e){return function(...r){d(e(...r))}}n(e=>{try{d(i.current)}finally{i.current=null}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,512,103,452],()=>t(43722));module.exports=s})();